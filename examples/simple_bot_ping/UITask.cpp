#include "UITask.h"

#include "../companion_radio/MyMesh.h"

#include <Arduino.h>
#include <target.h>

#define AUTO_OFF_MILLIS      10000  // 10 seconds
#define BOOT_SCREEN_MILLIS   4000   // 4 seconds

// 'meshcore', 128x13px
static const uint8_t meshcore_logo [] PROGMEM = {
    0x3c, 0x01, 0xe3, 0xff, 0xc7, 0xff, 0x8f, 0x03, 0x87, 0xfe, 0x1f, 0xfe, 0x1f, 0xfe, 0x1f, 0xfe, 
    0x3c, 0x03, 0xe3, 0xff, 0xc7, 0xff, 0x8e, 0x03, 0x8f, 0xfe, 0x3f, 0xfe, 0x1f, 0xff, 0x1f, 0xfe, 
    0x3e, 0x03, 0xc3, 0xff, 0x8f, 0xff, 0x0e, 0x07, 0x8f, 0xfe, 0x7f, 0xfe, 0x1f, 0xff, 0x1f, 0xfc, 
    0x3e, 0x07, 0xc7, 0x80, 0x0e, 0x00, 0x0e, 0x07, 0x9e, 0x00, 0x78, 0x0e, 0x3c, 0x0f, 0x1c, 0x00, 
    0x3e, 0x0f, 0xc7, 0x80, 0x1e, 0x00, 0x0e, 0x07, 0x1e, 0x00, 0x70, 0x0e, 0x38, 0x0f, 0x3c, 0x00, 
    0x7f, 0x0f, 0xc7, 0xfe, 0x1f, 0xfc, 0x1f, 0xff, 0x1c, 0x00, 0x70, 0x0e, 0x38, 0x0e, 0x3f, 0xf8, 
    0x7f, 0x1f, 0xc7, 0xfe, 0x0f, 0xff, 0x1f, 0xff, 0x1c, 0x00, 0xf0, 0x0e, 0x38, 0x0e, 0x3f, 0xf8, 
    0x7f, 0x3f, 0xc7, 0xfe, 0x0f, 0xff, 0x1f, 0xff, 0x1c, 0x00, 0xf0, 0x1e, 0x3f, 0xfe, 0x3f, 0xf0, 
    0x77, 0x3b, 0x87, 0x00, 0x00, 0x07, 0x1c, 0x0f, 0x3c, 0x00, 0xe0, 0x1c, 0x7f, 0xfc, 0x38, 0x00, 
    0x77, 0xfb, 0x8f, 0x00, 0x00, 0x07, 0x1c, 0x0f, 0x3c, 0x00, 0xe0, 0x1c, 0x7f, 0xf8, 0x38, 0x00, 
    0x73, 0xf3, 0x8f, 0xff, 0x0f, 0xff, 0x1c, 0x0e, 0x3f, 0xf8, 0xff, 0xfc, 0x70, 0x78, 0x7f, 0xf8, 
    0xe3, 0xe3, 0x8f, 0xff, 0x1f, 0xfe, 0x3c, 0x0e, 0x3f, 0xf8, 0xff, 0xfc, 0x70, 0x3c, 0x7f, 0xf8, 
    0xe3, 0xe3, 0x8f, 0xff, 0x1f, 0xfc, 0x3c, 0x0e, 0x1f, 0xf8, 0xff, 0xf8, 0x70, 0x3c, 0x7f, 0xf8, 
};

void UITask::begin(const char* name, const char* group) {
  _prevBtnState = HIGH;
  _auto_off = millis() + AUTO_OFF_MILLIS;
  _display->turnOn();

  sprintf(_node_name, "%s in %s", name, group);
}

void UITask::renderCurrScreen() {
  // meshcore logo
  _display->setColor(DisplayDriver::BLUE);
  constexpr int logoWidth = 128;
  _display->drawXbm((_display->width() - logoWidth) / 2, 3, meshcore_logo, logoWidth, 13);

  // battery info
  sprintf(_info, "Batt %1.2f v", static_cast<float>(board.getBattMilliVolts()) / 1000.0f);
  _display->setColor(DisplayDriver::LIGHT);
  _display->setTextSize(1);

  const uint16_t infoWidth = _display->getTextWidth(_info);
  _display->setCursor((_display->width() - infoWidth) / 2, 22);
  _display->print(_info);

  // node name
  const uint16_t nameWidth = _display->getTextWidth(_node_name);
  _display->setCursor((_display->width() - nameWidth) / 2, 35);
  _display->print(_node_name);

  // stats
  sprintf(_stats, "Q%d R%d S%d T%d L%d", _quiet, _total_request, _total_sent, _total_received, _last_msg_count);
  const uint16_t statsWidth = _display->getTextWidth(_stats);
  _display->setCursor((_display->width() - statsWidth) / 2, 48);
  _display->print(_stats);
}

void UITask::loop(bool quiet, unsigned long total_request, unsigned long total_sent, unsigned long total_received, unsigned long last_msg_count) {
#ifdef PIN_USER_BTN
  if (millis() >= _next_read) {
    const int btnState = digitalRead(PIN_USER_BTN);
    if (btnState != _prevBtnState) {
      if (btnState == LOW) {  // pressed?
        if (_display->isOn()) {
          // TODO: any action ?
        } else {
          _display->turnOn();
        }
        _auto_off = millis() + AUTO_OFF_MILLIS;   // extend auto-off timer
      }
      _prevBtnState = btnState;
    }
    _next_read = millis() + 200;  // 5 reads per second
  }
#endif

  if (millis() > _auto_off + 110000) {
    _display->turnOn();
    _auto_off = millis() + AUTO_OFF_MILLIS;
  }

  _quiet = quiet;
  _last_msg_count = last_msg_count;
  _total_request = total_request;
  _total_received = total_received;
  _total_sent = total_sent;

  if (_display->isOn()) {
    if (millis() >= _next_refresh) {
      _display->startFrame();
      renderCurrScreen();
      _display->endFrame();

      _next_refresh = millis() + 5000;   // refresh every 10 second
    }
    if (millis() > _auto_off) {
      _display->turnOff();
    }
  }
}
